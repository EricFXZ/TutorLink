<div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 animate-fade-in-fast p-4" (click)="closeModal()">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-2xl max-h-[90vh] flex flex-col" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="flex-shrink-0 flex justify-between items-start mb-4 pb-4 border-b border-gray-200 dark:border-gray-700">
      <div>
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">{{ session().subject.name }}</h3>
        <p class="text-md text-gray-600 dark:text-gray-400">Topic: {{ session().topic }}</p>
      </div>
      <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>

    <!-- Body -->
    <div class="flex-grow overflow-y-auto pr-2 -mr-2 space-y-6">
      <!-- Session Info Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-3 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
          <div>
            <p class="font-semibold text-gray-800 dark:text-gray-200">Tutor</p>
            <p class="text-gray-600 dark:text-gray-400">{{ session().tutor.name }}</p>
          </div>
        </div>
        @if (!session().isGlobal) {
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-3 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            <div>
              <p class="font-semibold text-gray-800 dark:text-gray-200">Student</p>
              <p class="text-gray-600 dark:text-gray-400">{{ session().student?.name }}</p>
            </div>
          </div>
        }
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-3 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
          <div>
            <p class="font-semibold text-gray-800 dark:text-gray-200">Date & Time</p>
            <p class="text-gray-600 dark:text-gray-400">{{ session().date | date:'fullDate' }} at {{ session().date | date:'shortTime' }}</p>
          </div>
        </div>
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-3 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <div>
            <p class="font-semibold text-gray-800 dark:text-gray-200">Duration</p>
            <p class="text-gray-600 dark:text-gray-400">{{ session().durationMinutes }} minutes</p>
          </div>
        </div>
        <div class="flex items-center sm:col-span-2">
            <svg class="w-5 h-5 mr-3 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <div>
              <p class="font-semibold text-gray-800 dark:text-gray-200">Status</p>
              <p class="text-gray-600 dark:text-gray-400">{{ session().status | titlecase }}</p>
            </div>
        </div>
      </div>

      <!-- Payment Info for Completed Sessions -->
      @if (session().status === 'completed') {
        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
           <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
             <div class="flex items-center">
                <svg class="w-5 h-5 mr-3 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414-.336.75-.75.75h-.75m0-1.5S20.25 4.5 20.25 4.5M3.75 12h15m-15 0v4.5m15-4.5v4.5m0-4.5l-15 4.5m15-4.5l-15 4.5" /></svg>
                <div>
                  <p class="font-semibold text-gray-800 dark:text-gray-200">Payment Status</p>
                  @if (session().isPaid) {
                    <p class="text-green-600 dark:text-green-400 font-medium">Paid</p>
                  } @else {
                     <p class="text-yellow-600 dark:text-yellow-400 font-medium">Unpaid</p>
                  }
                </div>
            </div>
            <div class="flex items-center">
                <p class="font-bold text-lg text-gray-500 mr-3">Lps</p>
                <div>
                  <p class="font-semibold text-gray-800 dark:text-gray-200">Tutor Payment</p>
                  <p class="text-gray-600 dark:text-gray-400">{{ (session().durationMinutes / 60 * 170).toFixed(2) }}</p>
                </div>
            </div>
          </div>
        </div>
      }

      <!-- Attendees list for Global Sessions -->
      @if (session().isGlobal) {
        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
          <h4 class="text-lg font-semibold mb-2">
            Attendees ({{ session().attendees?.length ?? 0 }} / {{ session().maxAttendees }})
          </h4>
          @if (session().attendees && session().attendees!.length > 0) {
            <ul class="space-y-2 max-h-40 overflow-y-auto bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
              @for (attendee of session().attendees; track attendee.id) {
                <li class="flex items-center">
                  <svg class="w-5 h-5 mr-3 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                  <span class="text-gray-700 dark:text-gray-300">{{ attendee.name }}</span>
                </li>
              }
            </ul>
          } @else {
            <p class="text-sm text-gray-500 dark:text-gray-400">No students have joined this session yet.</p>
          }
        </div>
      }

      <!-- Session Link -->
      <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center mb-2">
          <h4 class="text-lg font-semibold">Session Link</h4>
          @if (isTutor() && !isEditingLink() && session().status === 'confirmed') {
            <button (click)="editLink()" class="text-sm text-blue-600 hover:underline">
              {{ session().sessionLink ? 'Edit' : 'Add' }}
            </button>
          }
        </div>
        @if (isEditingLink()) {
          <div class="space-y-2">
            <input type="text" [(ngModel)]="editableLink" placeholder="https://meet.google.com/..." class="block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md focus:ring-blue-500 focus:border-blue-500">
            <div class="flex justify-end space-x-2">
              <button (click)="cancelEditLink()" class="text-sm py-1 px-3 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
              <button (click)="saveLink()" class="text-sm py-1 px-3 rounded-md bg-blue-600 text-white hover:bg-blue-700">Save</button>
            </div>
          </div>
        } @else {
          @if (session().sessionLink) {
            <a [href]="session().sessionLink!" target="_blank" class="flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:underline break-all">
              <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>
              {{ session().sessionLink }}
            </a>
          } @else {
            <p class="text-sm text-gray-500 dark:text-gray-400">No session link provided yet.</p>
          }
        }
      </div>

      <!-- Materials -->
      <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center mb-2">
          <h4 class="text-lg font-semibold">Session Materials</h4>
          @if (isTutor() && !isAddingMaterial() && (session().status === 'pending' || session().status === 'confirmed')) {
            <button (click)="addMaterial()" class="text-sm text-blue-600 hover:underline">Add</button>
          }
        </div>
        @if (session().materials.length > 0) {
          <ul class="space-y-2">
            @for (material of session().materials; track $index) {
              <li class="flex items-center justify-between p-2 rounded-md bg-gray-100 dark:bg-gray-700">
                <a [href]="material.url" target="_blank" class="flex items-center flex-grow min-w-0">
                  <svg class="w-5 h-5 mr-3 text-gray-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                  <span class="text-blue-600 dark:text-blue-400 hover:underline truncate">{{ material.name }}</span>
                </a>
                @if (isTutor() && (session().status === 'pending' || session().status === 'confirmed')) {
                  <button (click)="removeMaterial($index)" class="ml-4 p-1 text-red-500 hover:text-red-700 flex-shrink-0">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                  </button>
                }
              </li>
            }
          </ul>
        }
        @if (isAddingMaterial()) {
          <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg space-y-2">
            <input type="text" [(ngModel)]="newMaterial().name" placeholder="File Name (e.g., Worksheet.pdf)" class="block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md focus:ring-blue-500 focus:border-blue-500">
            <input type="text" [(ngModel)]="newMaterial().url" placeholder="URL (e.g., https://...)" class="block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md focus:ring-blue-500 focus:border-blue-500">
             <div class="flex justify-end space-x-2 pt-1">
              <button (click)="cancelAddMaterial()" class="text-sm py-1 px-3 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
              <button (click)="saveMaterial()" class="text-sm py-1 px-3 rounded-md bg-blue-600 text-white hover:bg-blue-700">Add</button>
            </div>
          </div>
        }
        @if (session().materials.length === 0 && !isAddingMaterial()) {
           <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">No materials have been added.</p>
        }
      </div>

      <!-- Comments -->
      <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center mb-2">
            <h4 class="text-lg font-semibold">Tutor Comments</h4>
             @if (isTutor() && !isEditingComments() && session().status === 'completed') {
              <button (click)="editComments()" class="text-sm text-blue-600 hover:underline">
                {{ session().comments ? 'Edit' : 'Add' }}
              </button>
            }
        </div>
        @if (isEditingComments()) {
           <div class="space-y-2">
            <textarea [(ngModel)]="editableComments" rows="4" placeholder="Add feedback for the student..." class="block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
            <div class="flex justify-end space-x-2">
              <button (click)="cancelEditComments()" class="text-sm py-1 px-3 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
              <button (click)="saveComments()" class="text-sm py-1 px-3 rounded-md bg-blue-600 text-white hover:bg-blue-700">Save</button>
            </div>
          </div>
        } @else {
          @if (session().comments) {
            <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
              <p class="text-sm text-gray-700 dark:text-gray-300 italic whitespace-pre-wrap">"{{ session().comments }}"</p>
            </div>
          } @else {
             <p class="text-sm text-gray-500 dark:text-gray-400">No comments from the tutor for this session.</p>
          }
        }
      </div>
    </div>

  </div>
</div>